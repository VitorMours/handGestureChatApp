{% extends "base.html" %} {% block content %}

<!-- Inclusão de Bibliotecas Necessárias -->
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script
  src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"
  crossorigin="anonymous"
></script>

<main class="container-fluid mt-4">
  <div class="row">
    <!-- Coluna do Chat -->
    <div class="col-md-12 col-lg-7 mb-4">
      <h2 class="fw-bold">Chat Room #{{ room_code }}</h2>
      <section
        id="chat-area"
        class="p-4 border rounded shadow"
        style="min-height: 70vh; overflow-y: auto"
      ></section>
      <form
        id="form-mensagem"
        class="mt-3"
        onsubmit="sendMessage(); return false;"
      >
        <div class="input-group">
          <input
            required
            type="text"
            class="form-control"
            id="mensagem"
            placeholder="Digite a sua mensagem..."
          />
          <button type="submit" class="btn btn-primary">Enviar</button>
        </div>
      </form>
      <div class="mt-3">
        <button
          class="btn btn-outline-secondary"
          onclick="toggleAccessibility()"
        >
          <i class="bi bi-webcam"></i> Ativar Acessibilidade
        </button>
      </div>
    </div>

    <!-- Coluna da Câmera -->
    <div id="camera-section" class="col-md-12 col-lg-5 d-none">
      <h4>Acessibilidade</h4>
      <div class="border rounded p-2 shadow position-relative">
        <video
          id="video-return"
          class="w-100 rounded"
          autoplay
          playsinline
        ></video>
        <canvas
          id="canvas-overlay"
          class="position-absolute top-0 start-0 w-100 h-100"
        ></canvas>
        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-outline-danger" onclick="stopAccessibility()">
            <i class="bi bi-x-circle"></i> Fechar Acessibilidade
          </button>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  let video = document.getElementById('video-return');
  let canvas = document.getElementById('canvas-overlay');

  navigator.mediaDevices
    .getUserMedia({video: true})
    .then((mediaStream) => {
      video.srcObject = mediaStream;
      video.onloadedmetadata = () => {
        video.play();
      };
    })
    .catch((err) => {
      // always check for errors at the end.
      console.error(`${err.name}: ${err.message}`);
    });

  function stopAccessibility() {
    document.getElementById('camera-section').classList.add('d-none');
  }

  function toggleAccessibility() {
    document.getElementById('camera-section').classList.remove('d-none');
    activateCamera();
  }

  // Chat Socket.IO
  const messages = document.getElementById('chat-area');
  const socketio = io();

  socketio.on('connect', () => console.log('Conectado ao chat...'));
  socketio.on('message', data => addMsg(data.name, data.message));

  function addMsg(name, msg) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('d-flex', 'justify-content-between', 'mb-2');
    messageElement.innerHTML = `
      <span><strong>${name}</strong>: ${msg}</span>
      <span class="text-muted">${new Date().toLocaleString()}</span>
    `;
    messages.appendChild(messageElement);
    messages.scrollTop = messages.scrollHeight;
  }

  function sendMessage() {
    const inp = document.getElementById('mensagem');
    if (!inp.value.trim()) return;
    socketio.emit('message', { data: inp.value });
    inp.value = '';
  }

  // Carregamento de mensagens anteriores (executado quando o DOM estiver carregado)
  document.addEventListener('DOMContentLoaded', () => {
    {% for msg in messages %}
      addMsg("{{ msg.name }}", "{{ msg.message }}");
    {% endfor %}
  });
</script>

{% endblock %}
